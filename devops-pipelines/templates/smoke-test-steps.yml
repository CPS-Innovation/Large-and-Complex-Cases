parameters:
- name: environment
  type: string
- name: postmanCollectionPath
  type: string
- name: appInstance
  type: string
- name: nodeVersion
  type: string

variables:
- group: lacc-backend-config-${{parameters.environment}}
- group: lacc-backend-secrets-${{parameters.environment}}
- group: lacc-automated-testing-${{parameters.environment}}

steps:
- task: UseNode@1
  displayName: 'Use Node.js'
  inputs:
    version: '20.x'

- script: |
    if command -v newman &> /dev/null; then
      echo "Newman already installed. Skipping installation."
    else
      echo "Installing newman and html reporter..."
      npm install -g --ignore-scripts newman@6.2.1 newman-reporter-htmlextra@1.23.1
      echo "newman version: $(newman -v)"
      echo "newman-reporter-htmlextra version: $(newman-reporter-htmlextra -v)"
    fi
  displayName: 'Install Newman Tools'

- script: |
      newman run ${{parameters.postmanCollectionPath}} \
      --env-var "baseUrl=https://${{parameters.appInstance}}.azurewebsites.net" \
      --env-var "uiUrl=https://lacc-app-ui-spa-${{parameters.environment}}.azurewebsites.net" \
      --env-var "tenantId=$(TenantId)" \
      --env-var "apiClientId=$(CallingAppValidAudience)" \
      --env-var "aadUsername=$(AadUserName)" \
      --env-var "aadPassword=$AadUserPassword" \
      --env-var "ddeiBaseUrl=$(DDEIOptionsBaseUrl)" \
      --env-var "ddeiAccessKey=$(DDEIOptionsAccessKey)" \
      --env-var "cmsUsername=$(CmsUserName)" \
      --env-var "cmsPassword=$(CmsUserPassword)" \
      --env-var "egressBaseUrl=$(EgressOptionsUrl)" \
      --env-var "egressUsername=$(EgressOptionsUsername)" \
      --env-var "egressPassword=$(EgressOptionsPassword)" \
      --env-var "egressWorkspaceId=$(EgressWorkspaceId)"
  displayName: 'Run Postman Collection'