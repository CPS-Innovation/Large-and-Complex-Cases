parameters:
  workingDir: 'ui-spa'
  testResultsDir: 'playwright/test-results'
  runBuild: false
  appUrl: 'https://$(webAppName).azurewebsites.net'

steps:
  - task: Npm@1
    displayName: 'Install Playwright Browsers'
    inputs:
      command: 'custom'
      customCommand: 'exec playwright install -- --with-deps'
      workingDir: ${{ parameters.workingDir }}
  
  - task: Npm@1
    displayName: 'Build App In Playwright Mode'
    condition: ${{ eq(parameters.runBuild, true) }}
    inputs:
      command: 'custom'
      customCommand: 'exec vite build -- --mode playwright'
      workingDir: ${{ parameters.workingDir }}

  - script: |
      echo "Running Playwright E2E tests with real-time output..."

      CMD="npm exec playwright test -- --reporter=list,html,junit --output=${{ parameters.testResultsDir }} --workers=1"

      if [ "$RUN_BUILD" = "true"]; then
        CMD="$CMD --base-url=${{ parameters.appUrl }}"
      fi

      eval $CMD

      echo "######### run pwd... ##########"
      pwd
      echo "######### run ls... ##########"
      ls

      echo "E2E tests completed. Reports:"
      ls -l ${{ parameters.testResultsDir }}
    displayName: 'Run E2E Tests'
    workingDirectory: ${{ parameters.workingDir }}
    continueOnError: true
    env:
      RUN_BUILD: ${{ lower(parameters.runBuild) }}


  - task: PublishTestResults@2
    displayName: 'Publish E2E Test Results'
    inputs:
      testResultsFormat: 'JUnit'
      testResultsFiles: '${{ parameters.workingDir }}/${{ parameters.testResultsDir }}/junit.xml'
      publishRunAttachments: true

  - task: PublishBuildArtifacts@1
    displayName: 'Publish E2E Test Report'
    inputs:
      pathtoPublish: '${{ parameters.workingDir }}/playwright/playwright-report'
      artifactName: 'e2e-test-report'