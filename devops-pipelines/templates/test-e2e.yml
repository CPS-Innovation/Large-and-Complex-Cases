parameters:
  workingDir: 'ui-spa'
  runBuild: true # This will build the app locally in playwright mode for testing. If set to false, tests will run on a live app at the url defined below.
  appUrl: 'https://$(webAppName).azurewebsites.net'

steps:
  - task: Npm@1
    displayName: 'Install Playwright Browsers'
    inputs:
      command: 'custom'
      customCommand: 'exec playwright install -- --with-deps'
      workingDir: ${{ parameters.workingDir }}
  
  - task: Npm@1
    displayName: 'Build App In Playwright Mode'
    condition: ${{ eq(parameters.runBuild, true) }}
    inputs:
      command: 'custom'
      customCommand: 'run ui:e2e:ci'
      workingDir: ${{ parameters.workingDir }}

  # - script: |
  #     echo "Running Playwright E2E tests with real-time output..."
      
  #     CMD="npm exec playwright test -- --reporter=list,html --workers=1"

  #     if [ "$RUN_BUILD" = "true"]; then
  #       CMD="$CMD --base-url=${{ parameters.appUrl }}"
  #     fi
      
  #     eval $CMD

  #     echo "E2E tests completed."
  #   displayName: 'Run E2E Tests'
  #   workingDirectory: ${{ parameters.workingDir }}
  #   continueOnError: true
  #   env:
  #     RUN_BUILD: ${{ lower(parameters.runBuild) }}

  - task: PublishBuildArtifacts@1
    displayName: 'Upload E2E Test Report As Build Artifact'
    inputs:
      pathtoPublish: '${{ parameters.workingDir }}/playwright/playwright-report'
      artifactName: 'e2e-test-report'

  - task: PublishTestResults@2
    displayName: 'Publish E2E Test Results'
    inputs:
      testResultsFormat: 'JUnit'
      testResultsFiles: '${{ parameters.workingDir }}/playwright/test-results/junit.xml'
      publishRunAttachments: true
    condition: always()

  - task: PublishCodeCoverageResults@2
    displayName: 'XML Publish E2E Code Coverage'
    inputs:
      summaryFileLocation: '${{ parameters.workingDir }}/playwright/test-results/junit.xml'
    condition: always()

  - task: PublishCodeCoverageResults@2
    displayName: 'HTML Publish E2E Code Coverage'
    inputs:
      summaryFileLocation: '${{ parameters.workingDir }}/playwright/playwright-report/index.html'
    condition: always()