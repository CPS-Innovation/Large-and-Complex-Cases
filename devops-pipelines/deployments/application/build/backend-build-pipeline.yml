trigger:
  batch: true
  branches:
    include:
      - main
      - HA/devops-stuff
  paths:
    include:
      - backend/*

pr:
  branches:
    include:
      - main
      - HA/devops-stuff
  paths:
    include:
      - backend/*

variables:
  buildConfiguration: 'Release'
  dotNetVersion: '8.x'
  testResultsDirectory: '$(Agent.TempDirectory)/TestResults'
  coverageReportsDirectory: '$(Agent.TempDirectory)/CoverageReports'

stages:
  - stage: Build_And_Test_Backend
    displayName: 'LACC - Build and Test Backend'
    jobs:
      - job: Build_Solution
        displayName: 'LACC - Build Backend Solution'
        pool:
          vmImage: ubuntu-latest
        steps:
          - task: UseDotNet@2
            displayName: 'Use .NET SDK'
            inputs:
              packageType: 'sdk'
              version: $(dotNetVersion)

          - task: DotNetCoreCLI@2
            displayName: 'Restore NuGet Packages'
            inputs:
              command: 'restore'
              projects: 'backend/CPS.ComplexCases.sln'
              feedsToUse: 'select'

          - task: DotNetCoreCLI@2
            displayName: 'Build Solution'
            inputs:
              command: 'build'
              projects: 'backend/CPS.ComplexCases.sln'
              arguments: '--configuration $(buildConfiguration) --no-restore'

          - task: DotNetCoreCLI@2
            displayName: 'Run All Tests'
            inputs:
              command: 'test'
              projects: 'backend/**/*Tests.csproj'
              arguments: '--configuration $(buildConfiguration) --no-build --logger trx --results-directory $(testResultsDirectory) --collect:"XPlat Code Coverage" --settings backend/CodeCoverage.runsettings'
            continueOnError: true

          - task: PublishTestResults@2
            displayName: 'Publish Test Results'
            inputs:
              testResultsFormat: 'VSTest'
              testResultsFiles: '**/*.trx'
              searchFolder: '$(testResultsDirectory)'
              publishRunAttachments: true
            condition: always()

          - task: PublishCodeCoverageResults@1
            displayName: 'Publish Code Coverage'
            inputs:
              codeCoverageTool: 'Cobertura'
              summaryFileLocation: '$(Agent.TempDirectory)/**/coverage.cobertura.xml'
              reportDirectory: '$(coverageReportsDirectory)'
            condition: always()

          - task: DotNetCoreCLI@2
            displayName: 'Install ReportGenerator Tool'
            inputs:
              command: 'custom'
              custom: 'tool'
              arguments: 'install --global dotnet-reportgenerator-globaltool'
            condition: always()

          - task: PowerShell@2
            displayName: 'Generate Beautiful HTML Coverage Report'
            inputs:
              targetType: 'inline'
              script: |
                # Find all coverage files
                $coverageFiles = Get-ChildItem -Path "$(Agent.TempDirectory)" -Filter "coverage.cobertura.xml" -Recurse
                
                if ($coverageFiles.Count -gt 0) {
                  $coverageFilePaths = $coverageFiles.FullName -join ";"
                  
                  # Generate beautiful HTML report
                  reportgenerator `
                    -reports:"$coverageFilePaths" `
                    -targetdir:"$(coverageReportsDirectory)/html" `
                    -reporttypes:"Html;HtmlSummary;Badges;TextSummary" `
                    -historydir:"$(coverageReportsDirectory)/history" `
                    -title:"CPS Complex Cases Backend Coverage Report" `
                    -tag:"$(Build.BuildNumber)" `
                    -assemblyfilters:"+*;-*.Tests;-*.WireMock" `
                    -classfilters:"+*;-*Tests*;-*Mock*;-*Migrations*" `
                    -verbosity:"Info"
                  
                  Write-Host "Coverage report generated successfully"
                  Write-Host "Report location: $(coverageReportsDirectory)/html"
                } else {
                  Write-Host "No coverage files found"
                }
            condition: always()

          - task: PublishBuildArtifacts@1
            displayName: 'Publish HTML Coverage Report'
            inputs:
              pathtoPublish: '$(coverageReportsDirectory)/html'
              artifactName: 'backend-coverage-report'
            condition: always()

      - job: Build_Main_API
        displayName: 'LACC - Build Main API Function App'
        dependsOn: Build_Solution
        pool:
          vmImage: ubuntu-latest
        steps:
          - task: UseDotNet@2
            displayName: 'Use .NET SDK'
            inputs:
              packageType: 'sdk'
              version: $(dotNetVersion)

          - task: DotNetCoreCLI@2
            displayName: 'Restore Main API'
            inputs:
              command: 'restore'
              projects: 'backend/CPS.ComplexCases.API/CPS.ComplexCases.API.csproj'

          - task: DotNetCoreCLI@2
            displayName: 'Build Main API'
            inputs:
              command: 'build'
              projects: 'backend/CPS.ComplexCases.API/CPS.ComplexCases.API.csproj'
              arguments: '--configuration $(buildConfiguration)'

          - task: DotNetCoreCLI@2
            displayName: 'Publish Main API'
            inputs:
              command: 'publish'
              projects: 'backend/CPS.ComplexCases.API/CPS.ComplexCases.API.csproj'
              publishWebProjects: false
              arguments: '--configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)/MainAPI --no-restore /p:SourceRevisionId=$(Build.SourceVersion)'

          - task: ArchiveFiles@2
            displayName: 'Archive Main API'
            inputs:
              rootFolderOrFile: '$(Build.ArtifactStagingDirectory)/MainAPI'
              includeRootFolder: false
              archiveType: 'zip'
              archiveFile: '$(Build.ArtifactStagingDirectory)/lacc-main-api-$(Build.BuildId).zip'
              replaceExistingArchive: true

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Main API Artifact'
            inputs:
              pathtoPublish: '$(Build.ArtifactStagingDirectory)/lacc-main-api-$(Build.BuildId).zip'
              artifactName: 'lacc-main-api-drop'

      - job: Build_FileTransfer_API
        displayName: 'LACC - Build FileTransfer API Function App'
        dependsOn: Build_Solution
        pool:
          vmImage: ubuntu-latest
        steps:
          - task: UseDotNet@2
            displayName: 'Use .NET SDK'
            inputs:
              packageType: 'sdk'
              version: $(dotNetVersion)

          - task: DotNetCoreCLI@2
            displayName: 'Restore FileTransfer API'
            inputs:
              command: 'restore'
              projects: 'backend/CPS.ComplexCases.FileTransfer.API/CPS.ComplexCases.FileTransfer.API.csproj'

          - task: DotNetCoreCLI@2
            displayName: 'Build FileTransfer API'
            inputs:
              command: 'build'
              projects: 'backend/CPS.ComplexCases.FileTransfer.API/CPS.ComplexCases.FileTransfer.API.csproj'
              arguments: '--configuration $(buildConfiguration)'

          - task: DotNetCoreCLI@2
            displayName: 'Publish FileTransfer API'
            inputs:
              command: 'publish'
              projects: 'backend/CPS.ComplexCases.FileTransfer.API/CPS.ComplexCases.FileTransfer.API.csproj'
              publishWebProjects: false
              arguments: '--configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)/FileTransferAPI --no-restore /p:SourceRevisionId=$(Build.SourceVersion)'

          - task: ArchiveFiles@2
            displayName: 'Archive FileTransfer API'
            inputs:
              rootFolderOrFile: '$(Build.ArtifactStagingDirectory)/FileTransferAPI'
              includeRootFolder: false
              archiveType: 'zip'
              archiveFile: '$(Build.ArtifactStagingDirectory)/lacc-filetransfer-api-$(Build.BuildId).zip'
              replaceExistingArchive: true

          - task: PublishBuildArtifacts@1
            displayName: 'Publish FileTransfer API Artifact'
            inputs:
              pathtoPublish: '$(Build.ArtifactStagingDirectory)/lacc-filetransfer-api-$(Build.BuildId).zip'
              artifactName: 'lacc-filetransfer-api-drop'

      - job: Package_Database_Scripts
        displayName: 'LACC - Package Database Migration Scripts'
        dependsOn: Build_Solution
        pool:
          vmImage: ubuntu-latest
        steps:
          - task: UseDotNet@2
            displayName: 'Use .NET SDK'
            inputs:
              packageType: 'sdk'
              version: $(dotNetVersion)

          - task: DotNetCoreCLI@2
            displayName: 'Install EF Core Tools'
            inputs:
              command: 'custom'
              custom: 'tool'
              arguments: 'install --global dotnet-ef'

          - task: DotNetCoreCLI@2
            displayName: 'Generate Migration Scripts'
            inputs:
              command: 'custom'
              custom: 'ef'
              arguments: 'migrations script --output $(Build.ArtifactStagingDirectory)/migration-script.sql --project backend/CPS.ComplexCases.Data/CPS.ComplexCases.Data.csproj --startup-project backend/CPS.ComplexCases.API/CPS.ComplexCases.API.csproj'

          - task: CopyFiles@2
            displayName: 'Copy Migration Files'
            inputs:
              sourceFolder: 'backend/CPS.ComplexCases.Data/Migrations'
              contents: '**'
              targetFolder: '$(Build.ArtifactStagingDirectory)/migrations'

          - task: ArchiveFiles@2
            displayName: 'Archive Database Scripts'
            inputs:
              rootFolderOrFile: '$(Build.ArtifactStagingDirectory)'
              includeRootFolder: false
              archiveType: 'zip'
              archiveFile: '$(Build.ArtifactStagingDirectory)/database-scripts-$(Build.BuildId).zip'
              replaceExistingArchive: true
              excludeRootFolder: true

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Database Scripts Artifact'
            inputs:
              pathtoPublish: '$(Build.ArtifactStagingDirectory)/database-scripts-$(Build.BuildId).zip'
              artifactName: 'database-scripts-drop' 