trigger:
  batch: true
  branches:
    include:
      - main
  paths:
    include:
      - backend/*

pr: none

variables:
  buildConfiguration: 'Release'
  dotNetVersion: '8.x'
  efVersion: '8.0.*'
  testResultsDirectory: '$(Agent.TempDirectory)/TestResults'

pool: 'LACC PreProd Pool'

stages:
  - stage: Package_NuGet
    displayName: 'Produce Nuget Package'
    jobs: 
    - job: Package_NuGet
      displayName: 'Pack and Publish NuGet Package'
      steps:
        - template: ../templates/dotnet-build-steps.yml
          parameters:
            projectPath: 'backend/CPS.ComplexCases.API.HttpTelemetry/CPS.ComplexCases.API.HttpTelemetry.csproj'
            projectName: 'HttpTelemetry'
            buildConfiguration: $(buildConfiguration)
            dotNetVersion: $(dotNetVersion)
            useLocalNuGet: false
            publishOutput: false
            runTests: false

        - script: |
            mkdir -p $(Build.SourcesDirectory)/localnuget
            rm -f $(Build.SourcesDirectory)/localnuget/*.nupkg
          displayName: 'Prepare local NuGet directory'

        - task: DotNetCoreCLI@2
          displayName: 'Pack HttpTelemetry'
          inputs:
            command: 'pack'
            packagesToPack: 'backend/CPS.ComplexCases.API.HttpTelemetry/CPS.ComplexCases.API.HttpTelemetry.csproj'
            outputDir: '$(Build.SourcesDirectory)/localnuget'
            arguments: '--configuration $(buildConfiguration) --no-build'

        - task: PublishPipelineArtifact@1
          displayName: 'Publish HttpTelemetry Package'
          inputs:
            targetPath: '$(Build.SourcesDirectory)/localnuget'
            artifact: 'localnuget'
    
  # - stage: Build_Main_API
  #   displayName: 'Build Main API'
  #   dependsOn: Package_NuGet
  #   jobs:
  #     - job: Build_Main_API
  #       displayName: 'Build Main API'
  #       steps:
  #         - template: ../templates/dotnet-build-steps.yml
  #           parameters:
  #             projectPath: 'backend/CPS.ComplexCases.API/CPS.ComplexCases.API.csproj'
  #             projectName: 'lacc-main-api-drop'
  #             buildConfiguration: $(buildConfiguration)
  #             dotNetVersion: $(dotNetVersion)
  #             useLocalNuGet: true
  #             publishOutput: true
  #             runTests: false

  # - stage: Build_Filetransfer_API
  #   displayName: 'Build Transfer API'
  #   dependsOn: Package_NuGet
  #   jobs:
  #     - job: Build_FileTransfer_API
  #       displayName: 'Build FileTransfer API'
  #       steps:
  #         - template: ../templates/dotnet-build-steps.yml
  #           parameters:
  #             projectPath: 'backend/CPS.ComplexCases.FileTransfer.API/CPS.ComplexCases.FileTransfer.API.csproj'
  #             projectName: 'lacc-filetransfer-api-drop'
  #             buildConfiguration: $(buildConfiguration)
  #             dotNetVersion: $(dotNetVersion)
  #             useLocalNuGet: true
  #             publishOutput: true
  #             runTests: false

  - stage: Package_Database
    displayName: 'Build Database Migration Scripts'
    dependsOn: Package_NuGet
    jobs:
      - job: Package_Database_Scripts
        displayName: 'Package Database Migration Scripts'
        variables: 
        - group: lacc-backend-secrets-dev
        steps:
          # Build Data project with dependencies
          - template: ../templates/dotnet-build-steps.yml
            parameters:
              projectPath: 'backend/CPS.ComplexCases.Data/CPS.ComplexCases.Data.csproj'
              projectName: 'Database'
              buildConfiguration: $(buildConfiguration)
              dotNetVersion: $(dotNetVersion)
              useLocalNuGet: true
              publishOutput: false
              runTests: false

          - task: Bash@3
            displayName: 'Generate Migration Scripts'
            inputs:
              filePath: '../scripts/generateDBMigrationScripts.sh'
            env:
              EF_VERSION: $(efVersion)
              DATA_PROJECT_PATH: 'backend/CPS.ComplexCases.Data/CPS.ComplexCases.Data.csproj'
              STARTUP_PROJECT_PATH: 'backend/CPS.ComplexCases.API/CPS.ComplexCases.API.csproj'
              MIGRATION_SCRIPT_OUT: '$(Build.ArtifactStagingDirectory)/migration-script.sql'
              ROLLBACK_SCRIPT_OUT: '$(Build.ArtifactStagingDirectory)/rollback-migration-script.sql'

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Database Scripts'
            inputs:
              pathtoPublish: '$(Build.ArtifactStagingDirectory)'
              artifactName: 'database-scripts-drop'