trigger: none
  # batch: true
  # branches:
  #   include:
  #     - main
  # paths:
  #   include:
  #     - backend/*

pr: none

variables:
  buildConfiguration: 'Release'
  dotNetVersion: '8.x'
  testResultsDirectory: '$(Agent.TempDirectory)/TestResults'
  coverageReportsDirectory: '$(Agent.TempDirectory)/CoverageReports'

pool:
  vmImage: ubuntu-latest

stages:
  - stage: Build_Main_API
    displayName: 'LACC Backend - Build Main API'
    jobs:
      - job: Build_Main_API
        displayName: 'Build Main API'
        steps:
          - template: ../templates/dotnet-build-steps.yml
            parameters:
              projectPath: 'backend/CPS.ComplexCases.API/CPS.ComplexCases.API.csproj'
              projectName: 'lacc-main-api-drop'
              buildConfiguration: $(buildConfiguration)
              dotNetVersion: $(dotNetVersion)
              useLocalNuGet: true
              nugetArtifactSource: 'specific'
              nugetArtifactPipeline: 'LACC-BE-dev-test'
              publishOutput: true
              runTests: false

  - stage: Build_Filetransfer_API
    displayName: 'LACC Backend - Build Main API'
    dependsOn: []
    jobs:
      - job: Build_FileTransfer_API
        displayName: 'Build FileTransfer API'
        steps:
          - template: ../templates/dotnet-build-steps.yml
            parameters:
              projectPath: 'backend/CPS.ComplexCases.FileTransfer.API/CPS.ComplexCases.FileTransfer.API.csproj'
              projectName: 'lacc-filetransfer-api-drop'
              buildConfiguration: $(buildConfiguration)
              dotNetVersion: $(dotNetVersion)
              useLocalNuGet: true
              nugetArtifactSource: 'specific'
              nugetArtifactPipeline: 'LACC-BE-dev-test'
              publishOutput: true
              runTests: false

  - stage: Package_Database
    displayName: 'LACC Backend - Build Database Migration Scripts'
    dependsOn: []
    jobs:
      - job: Package_Database_Scripts
        displayName: 'Package Database Migration Scripts'
        pool:
          vmImage: ubuntu-latest
        steps:
          # Build Data project with dependencies
          - template: ../templates/dotnet-build-steps.yml
            parameters:
              projectPath: 'backend/CPS.ComplexCases.Data/CPS.ComplexCases.Data.csproj'
              projectName: 'Database'
              buildConfiguration: $(buildConfiguration)
              dotNetVersion: $(dotNetVersion)
              useLocalNuGet: true
              nugetArtifactSource: 'specific'
              nugetArtifactPipeline: 'LACC-BE-dev-test'
              publishOutput: false
              runTests: false

          - task: DotNetCoreCLI@2
            displayName: 'Install EF Core Tools'
            inputs:
              command: 'custom'
              custom: 'tool'
              arguments: 'install --global dotnet-ef'

          - task: DotNetCoreCLI@2
            displayName: 'Generate Migration Scripts'
            inputs:
              command: 'custom'
              custom: 'ef'
              arguments: 'migrations script --output $(Build.ArtifactStagingDirectory)/migration-script.sql --project backend/CPS.ComplexCases.Data/CPS.ComplexCases.Data.csproj --startup-project backend/CPS.ComplexCases.API/CPS.ComplexCases.API.csproj'

          - task: CopyFiles@2
            displayName: 'Copy Migration Files'
            inputs:
              sourceFolder: 'backend/CPS.ComplexCases.Data/Migrations'
              contents: '**'
              targetFolder: '$(Build.ArtifactStagingDirectory)/migrations'

          - task: ArchiveFiles@2
            displayName: 'Archive Database Scripts'
            inputs:
              rootFolderOrFile: '$(Build.ArtifactStagingDirectory)'
              includeRootFolder: false
              archiveType: 'zip'
              archiveFile: '$(Build.ArtifactStagingDirectory)/database-scripts.zip'
              replaceExistingArchive: true

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Database Scripts'
            inputs:
              pathtoPublish: '$(Build.ArtifactStagingDirectory)/database-scripts.zip'
              artifactName: 'database-scripts-drop'