name: Build-$(Year:yyyy).$(Month).$(DayOfMonth).$(Rev:r)

trigger: none

pr:
  branches:
    include:
      - main
  paths:
    include:
      - backend/*

variables:
  buildConfiguration: 'Release'
  dotNetVersion: '8.x'
  testResultsDirectory: '$(Agent.TempDirectory)/TestResults'
  coverageReportsDirectory: '$(Agent.TempDirectory)/CoverageReports'
  packageVersion: '$(Year:yy).$(Month).$(DayOfMonth).$(Rev:r)'

pool: 'LACC PreProd Pool'

stages:
  - stage: Build_And_Test_Backend
    displayName: 'LACC Backend - Build, Test & Package'
    jobs:
      - job: Package_NuGet
        displayName: 'Pack and Publish NuGet Package'
        steps:
          - checkout: self
            sparseCheckoutDirectories: backend devops-pipelines/templates

          - template: ../templates/dotnet-build-steps.yml
            parameters:
              projectPath: 'backend/CPS.ComplexCases.API.HttpTelemetry/CPS.ComplexCases.API.HttpTelemetry.csproj'
              projectName: 'HttpTelemetry'
              buildConfiguration: $(buildConfiguration)
              dotNetVersion: $(dotNetVersion)
              publishOutput: false
              runTests: false

          # - task: DotNetCoreCLI@2
          #   displayName: 'Pack HttpTelemetry'
          #   inputs:
          #     command: 'pack'
          #     packagesToPack: 'backend/CPS.ComplexCases.API.HttpTelemetry/CPS.ComplexCases.API.HttpTelemetry.csproj'
          #     configuration: '$(buildConfiguration)'
          #     versioningScheme: 'byBuildNumber'

          - task: DotNetCoreCLI@2
            displayName: 'Pack HttpTelemetry'
            inputs:
              command: 'custom'
              projects: 'backend/CPS.ComplexCases.API.HttpTelemetry/CPS.ComplexCases.API.HttpTelemetry.csproj'
              custom: 'pack'
              arguments: '--configuration $(buildConfiguration) --no-restore --no-build -p:PackageVersion=$(packageVersion) --output $(Build.ArtifactStagingDirectory)'


          - task: DotNetCoreCLI@2
            displayName: 'Push HttpTelemetry package'
            inputs:
              command: 'push'
              packagesToPush: '$(Build.ArtifactStagingDirectory)/*.nupkg'
              publishVstsFeed: 'Information Management/LACC-backend'


      - job: Build_And_Test_Solution
        displayName: 'Build & Test Solution'
        dependsOn: Package_NuGet
        steps:
          - template: ../templates/dotnet-build-steps.yml
            parameters:
              projectPath: 'backend/CPS.ComplexCases.sln'
              projectName: 'Backend Solution'
              buildConfiguration: '$(buildConfiguration)'
              dotNetVersion: $(dotNetVersion)
              publishOutput: false
              runTests: true
              testResultsDirectory: $(testResultsDirectory)
              coverageReportsDirectory: $(coverageReportsDirectory)

          # Generate coverage report
          - template: ../templates/dotnet-code-coverage-steps.yml
            parameters:
              coverageReportsDirectory: $(coverageReportsDirectory)
              projectName: 'Backend'

      - job: Build_Main_API
        displayName: 'LACC - Build Main API'
        dependsOn: Build_And_Test_Solution
        steps:
          # Build and publish Main API
          - template: ../templates/dotnet-build-steps.yml
            parameters:
              projectPath: 'backend/CPS.ComplexCases.API/CPS.ComplexCases.API.csproj'
              projectName: 'lacc-main-api-drop'
              buildConfiguration: $(buildConfiguration)
              dotNetVersion: $(dotNetVersion)
              publishOutput: true
              runTests: false

      - job: Build_FileTransfer_API
        displayName: 'LACC - Build FileTransfer API'
        dependsOn: Build_And_Test_Solution
        steps:
          # Build and publish FileTransfer API
          - template: ../templates/dotnet-build-steps.yml
            parameters:
              projectPath: 'backend/CPS.ComplexCases.FileTransfer.API/CPS.ComplexCases.FileTransfer.API.csproj'
              projectName: 'lacc-filetransfer-api-drop'
              buildConfiguration: $(buildConfiguration)
              dotNetVersion: $(dotNetVersion)
              publishOutput: true
              runTests: false

      - job: Package_Database_Scripts
        displayName: 'LACC - Package Database Migration Scripts'
        dependsOn: Build_And_Test_Solution
        steps:
          # Build Data project with dependencies
          - template: ../templates/dotnet-build-steps.yml
            parameters:
              projectPath: 'backend/CPS.ComplexCases.Data/CPS.ComplexCases.Data.csproj'
              projectName: 'Database'
              buildConfiguration: $(buildConfiguration)
              dotNetVersion: $(dotNetVersion)
              publishOutput: false
              runTests: false

          - task: Bash@3
            displayName: 'Generate Migration Scripts'
            inputs:
              targetType: 'inline'
              script: |
                export PATH="$PATH:$HOME/.dotnet/tools"
                
                if ! dotnet ef --version &> /dev/null; then
                  dotnet tool install --global dotnet-ef
                fi

                dotnet ef migrations script \
                --idempotent \
                --output $(Build.ArtifactStagingDirectory)/migration-script.sql \
                --project backend/CPS.ComplexCases.Data/CPS.ComplexCases.Data.csproj \
                --startup-project backend/CPS.ComplexCases.API/CPS.ComplexCases.API.csproj