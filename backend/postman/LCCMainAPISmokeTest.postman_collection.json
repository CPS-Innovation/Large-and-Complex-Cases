{
  "info": {
    "_postman_id": "e3c35e2d-90ea-4168-b17a-4727081722fc",
    "name": "LCCMainAPISmokeTest",
<<<<<<< HEAD
    "description": "Smoke test to verify connection to all external services.\n\n## Overview\n\nThis collection tests LCC's main API connectivity to its external dependencies:  \n\\- Case Management Datastore  \n\\- CMS  \n\\- Egress  \n\\- NetApp\n\n## Authentication\n\n### Azure AD Token (Collection Level)\n\nThe collection-level pre-request script automatically retrieves an Azure AD access token using the OAuth 2.0 Resource Owner Password CredentialsÂ (ROPC) grant flow.\n\n**How it works:**  \n\\- Tokens are fetched using collection variables: \\`tenantId\\`, \\`clientId\\`, \\`aadUsername\\`, \\`aadPassword\\`  \n\\- Token is cached in \\`accessToken\\` and \\`accessTokenExpiry\\` collection variables  \n\\- Auto-refreshes 60 seconds before expiry  \n\\- Authorization header set at collection level: \\`Bearer \\`\n\n### CMS Authentication Cookie\n\nThe **Cms-Auth-Values** cookie is set via pre-request script:  \n\\- Calls the environment-specific MDS \\`/authenticate\\` endpoint  \n\\- Uses \\`ddeiBaseUrl\\`, \\`cmsUsername\\`, \\`cmsPassword\\` variables  \n\\- Retrieves and sets the authentication cookie value automatically\n\n## Setup Instructions\n\n1\\. Import Collection and Environment\n\nImport the following files into Postman:  \n\\- \\`LCCMainAPISmokeTest.postman_collection.json\\`  \n\\- Your environment file (Local, Dev, etc.)\n\n2\\. Configure Collection Variables\n\nEnsure these collection variables are populated:\n\n| Variable | Description | Notes |\n| --- | --- | --- |\n| urnUniqueRef | 5-digit unique reference number | Autogenerated in Pre-Script |\n| accessTokenExpiry | Token expiry timestamp (auto-managed) | Autogenerated in Pre-Script |\n| ddeiBaseUrl | MDS API base URL |  |\n| ddeiAccessKey | MDS API access key |  |\n| cmsUsername | CMS authentication username |  |\n| cmsPassword | CMS authentication password |  |\n| cmsAuth | CMS auth cookie value (auto-managed) | Autogenerated in Pre-Script |\n| baseUrl | LCC API URL |  |\n| clientId | Azure AD application (client) ID |  |\n| aadUsername | Azure AD username |  |\n| aad Password | Azure AD user password |  |\n| tenantId | Azure AD application (tenant) ID |  |\n\n## Test Requests\n\nThe collection hits four key endpoints:\n\n| Endpoint | What it proves |\n| --- | --- |\n| `GET /api/status` | The API is running.  <br>Also used to verify authentication to CMS and AAD and stops run if unsuccessful. |\n| `GET /api/v1/activity/logs` | Datastore connection working |\n| `GET /api/v1/areas` | DDEI/CMS connection working |\n| `GET /api/v1/egress/workspaces/{id}/files` | Egress connection working |\n| `GET /api/v1/netapp/files` | NetApp connectionworking |\n\n## Pre-Request Script\n\nThe collection pre-request script automatically generates:  \n\\- \\`correlationId\\` - A new GUID for each request  \n\\- \\`today\\` - Current date in ISO format  \n\\- \\`tomorrow\\` - Tomorrow's date in ISO format  \n\\- \\`urnUniqueRef\\` - A random 5-digit number\n\n## Troubleshooting\n\n**Authentication Failures**\n\n\\- Verify \\`tenantId\\`, \\`clientId\\`, \\`aadUsername\\`, and \\`aadPassword\\` are correct  \n\\- Check Azure AD app registration has appropriate API permissions  \n\\- Ensure CMS credentials (\\`cmsUsername\\`, \\`cmsPassword\\`) are valid\n\n**Token Not Refreshing**\n\n\\- The token auto-refreshes 60s before expiry  \n\\- If issues persist, manually delete \\`accessToken\\` and \\`accessTokenExpiry\\` variables to force a new token\n\nCookie Issues\n\n\\- Verify \\`ddeiBaseUrl\\` points to the correct environment  \n\\- Check DDEI \\`/authenticate\\` endpoint is accessible  \n\\- Ensure \\`ddeiAccessKey\\` is valid\n\n**Test Failures**\n\n\\- Review the \"Test Results\" tab for specific assertion failures  \n\\- Check the response body for validation errors  \n\\- Verify request payload matches expected schema",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json",
  },
  "item": [
    {
      "name": "1 Verify Auth",
      "event": [
        {
          "listen": "prerequest",
          "script": {
            "exec": [
              ""
            ],
            "type": "text/javascript",
            "packages": {},
            "requests": {}
          }
        },
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('API is accessible', function() {",
              "    pm.expect(pm.response.code).to.be.oneOf([200, 401, 403]);",
              "});",
              "",
              "const token = pm.collectionVariables.get('accessToken');",
              "const cmsAuth = pm.collectionVariables.get('cmsAuth');",
              "",
              "if (token && cmsAuth) {",
              "    console.log('Ready to make API calls!');",
              "} else {",
              "    if (!token) console.error('X AAD Token missing.');",
              "    if (!cmsAuth) console.error('X CMS Auth missing.');",
              "    pm.execution.setNextRequest(null);",
              "    throw new Error('Missing authentication credentials. Stopping collection run.')",
              "}"
            ],
            "type": "text/javascript",
            "packages": {},
            "requests": {}
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "Accept",
            "value": "application/json"
          },
          {
            "key": "Correlation-Id",
            "value": "{{correlationId}}"
          }
        ],
        "url": {
          "raw": "{{baseUrl}}/api/status",
          "host": [
            "{{baseUrl}}"
          ],
          "path": [
            "api",
            "status"
          ]
        },
        "description": "Verify that authentication tokens are set.\n\nRun this after 1.1 and 1.2 to confirm both tokens are obtained."
      },
      "response": []
    },
    {
      "name": "2. Datastore - Get Activity Logs",
=======
    "description": "Minimal smoke test to verify connection to all external services.\n\n## Overview\n\nThis collection tests LCC's main API connectivity to its external dependencies:  \n\\- Case Management Datastore  \n\\- CMS  \n\\- Egress  \n\\- NetApp\n\n## Authentication\n\n### Azure AD Token (Collection Level)\n\nThe collection-level pre-request script automatically retrieves an Azure AD access token using the OAuth 2.0 client credentials flow (v2.0 endpoint).\n\n**How it works:**  \n\\- Tokens are fetched using collection variables: \\`tenantId\\`, \\`clientId\\`, \\`clientSecret\\`, \\`scope\\`  \n\\- Token is cached in \\`accessToken\\` and \\`accessTokenExpiry\\` collection variables  \n\\- Auto-refreshes 60 seconds before expiry  \n\\- Authorization header set at collection level: \\`Bearer \\`\n\n### CMS Authentication Cookie\n\nThe **Cms-Auth-Values** cookie is set via pre-request script:  \n\\- Calls the environment-specific MDS \\`/authenticate\\` endpoint  \n\\- Uses \\`mdsBaseUrl\\`, \\`cmsUsername\\`, \\`cmsPassword\\` variables  \n\\- Retrieves and sets the authentication cookie value automatically\n\n## Setup Instructions\n\n1\\. Import Collection and Environment\n\nImport the following files into Postman:  \n\\- \\`LCCMainAPISmokeTest.postman_collection.json\\`  \n\\- Your environment file (Local, Dev, etc.)\n\n2\\. Configure Collection Variables\n\nEnsure these collection variables are populated:\n\n| Variable | Description | Notes |\n| --- | --- | --- |\n| urnUniqueRef | 5-digit unique reference number | Autogenerated in Pre-Script |\n| accessTokenExpiry | Token expiry timestamp (auto-managed) | Autogenerated in Pre-Script |\n| mdsBaseUrl | MDS API base URL |  |\n| mdsAccessKey | MDS API access key |  |\n| cmsUsername | CMS authentication username |  |\n| cmsPassword | CMS authentication password |  |\n| cmsAuth | CMS auth cookie value (auto-managed) | Autogenerated in Pre-Script |\n| baseUrl | LCC API URL |  |\n| clientId | Azure AD application (client) ID |  |\n| clientSecret | Azure AD application (client) secret |  |\n| tenantId | Azure AD application (tenant) ID |  |\n| scope | Azure AD application (scope) | api:///.default |\n\n## Test Requests\n\nThe collection hits four key endpoints:\n\n| Endpoint | What it proves |\n| --- | --- |\n| `GET /api/v1/activity/logs` | Datastore connection working |\n| `GET /api/v1/areas` | DDEI/CMS connection working |\n| `GET /api/v1/egress/workspaces/{id}/files` | Egress connection working |\n| `GET /api/v1/netapp/files` | NetApp connectionworking |\n\n## Pre-Request Script\n\nThe collection pre-request script automatically generates:  \n\\- \\`correlationId\\` - A new GUID for each request  \n\\- \\`today\\` - Current date in ISO format  \n\\- \\`tomorrow\\` - Tomorrow's date in ISO format  \n\\- \\`urnUniqueRef\\` - A random 5-digit number (unless overridden)\n\n**Overriding urnUniqueRef**\n\nTo use a specific URN reference number:  \n1\\. Set \\`urnUniqueRef\\` in your collection or environment variables  \n2\\. The pre-request script will use your value instead of generating a random one\n\n## Troubleshooting\n\n**Authentication Failures**\n\n\\- Verify \\`tenantId\\`, \\`clientId\\`, \\`clientSecret\\`, and \\`scope\\` are correct  \n\\- Check Azure AD app registration has appropriate API permissions  \n\\- Ensure MDS credentials (\\`cmsUsername\\`, \\`cmsPassword\\`) are valid\n\n**Token Not Refreshing**\n\n\\- The token auto-refreshes 60s before expiry  \n\\- If issues persist, manually delete \\`accessToken\\` and \\`accessTokenExpiry\\` variables to force a new token\n\nCookie Issues\n\n\\- Verify \\`mdsBaseUrl\\` points to the correct environment  \n\\- Check MDS \\`/authenticate\\` endpoint is accessible  \n\\- Ensure \\`mdsAccessKey\\` is valid\n\n**Test Failures**\n\n\\- Review the \"Test Results\" tab for specific assertion failures  \n\\- Check the response body for validation errors  \n\\- Verify request payload matches expected schema",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json",
    "_exporter_id": "48292597",
    "_collection_link": "https://go.postman.co/collection/48292597-e3c35e2d-90ea-4168-b17a-4727081722fc?source=collection_link"
  },
  "item": [
    {
      "name": "1. Datastore - Get Activity Logs",
>>>>>>> 8deb5fa (add postman collection and pipeline steps)
      "event": [
        {
          "listen": "prerequest",
          "script": {
            "exec": [
              ""
            ],
            "type": "text/javascript",
            "packages": {},
            "requests": {}
          }
        },
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Status code is 200', function() {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test('Response has correct structure', function() {",
              "    const response = pm.response.json();",
              "    pm.expect(response).to.have.property('data');",
              "    pm.expect(response).to.have.property('pagination');",
              "    pm.expect(response.data).to.be.an('array');",
              "    pm.expect(response.pagination).to.have.property('count');",
              "    pm.expect(response.pagination).to.have.property('totalResults');",
              "});",
              "",
              "const response = pm.response.json();",
              "const logs = response.data || [];",
              "",
              "console.log('=== Activity Logs ===');",
              "console.log('Total:', response.pagination?.totalResults);",
              "console.log('Returned:', logs.length);",
              "",
              "if (logs.length > 0) {",
              "    // Validate log structure",
              "    pm.test('Activity log has required fields', function() {",
              "        const log = logs[0];",
              "        pm.expect(log).to.have.property('id');",
              "        pm.expect(log).to.have.property('caseId');",
              "        pm.expect(log).to.have.property('actionType');",
              "        pm.expect(log).to.have.property('userName');",
              "        pm.expect(log).to.have.property('resourceType');",
              "        pm.expect(log).to.have.property('timestamp');",
              "    });",
              "    ",
              "    // Get latest activity",
              "    const latestLog = logs[0];",
              "    pm.environment.set('latestActivityId', latestLog.id);",
              "    ",
              "    console.log('[OK] Latest activity:');",
              "    console.log('    ID:', latestLog.id);",
              "    console.log('    Type:', latestLog.actionType);",
              "    console.log('    User:', latestLog.userName);",
              "    console.log('    Time:', latestLog.timestamp);",
              "}"
            ],
            "type": "text/javascript",
            "packages": {},
            "requests": {}
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "Accept",
            "value": "*/*"
          },
          {
            "key": "Authorization",
            "value": "Bearer {{accessToken}}"
          },
          {
            "key": "Cookie",
            "value": "Cms-Auth-Values={{cmsAuth}}"
          },
          {
            "key": "Correlation-Id",
            "value": "{{correlationId}}"
          },
          {
            "key": "Origin",
            "value": "{{uiUrl}}"
          }
        ],
        "url": {
          "raw": "{{baseUrl}}/api/v1/activity/logs?caseId={{caseId}}",
          "host": [
            "{{baseUrl}}"
          ],
          "path": [
            "api",
            "v1",
            "activity",
            "logs"
          ],
          "query": [
            {
              "key": "caseId",
              "value": "{{caseId}}"
            }
          ]
        },
        "description": "Get activity logs for a case.\n\n**Proves:** Database Connection working.\n\n**Outputs:**\n\n- `latestActivityId` - ID of most recent activity"
      },
      "response": []
    },
    {
<<<<<<< HEAD
      "name": "3. CMS - List Areas",
=======
      "name": "2. CMS - List Areas",
>>>>>>> 8deb5fa (add postman collection and pipeline steps)
      "event": [
        {
          "listen": "prerequest",
          "script": {
            "exec": [
              ""
            ],
            "type": "text/javascript",
            "packages": {},
            "requests": {}
          }
        },
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Status code is 200', function() {\r",
              "    pm.response.to.have.status(200);\r",
              "});\r",
              "\r",
              "pm.test('Response is JSON array or object', function() {\r",
              "    pm.response.to.be.json;\r",
              "});\r",
              "\r",
              "if (pm.response.code === 200) {\r",
              "    const response = pm.response.json();\r",
              "    const areas = Array.isArray(response.allAreas) ? response.allAreas : [];\r",
              "    console.log('Areas count:', areas.length);\r",
              "}"
            ],
            "type": "text/javascript",
            "packages": {},
            "requests": {}
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{accessToken}}",
            "description": "Azure AD JWT token",
            "type": "text"
          },
          {
            "key": "Cookie",
            "value": "Cms-Auth-Values={{cmsAuth}}",
            "description": "CMS session cookies",
            "type": "text"
          },
          {
            "key": "Accept",
            "value": "application/json",
            "type": "text"
          },
          {
            "key": "Correlation-Id",
            "value": "{{correlationId}}",
            "type": "text"
          },
          {
            "key": "Origin",
            "value": "{{uiUrl}}",
            "type": "text"
          }
        ],
        "url": {
          "raw": "{{baseUrl}}/api/v1/areas",
          "host": [
            "{{baseUrl}}"
          ],
          "path": [
            "api",
            "v1",
            "areas"
          ]
        },
        "description": "List all available areas\n\n**Proves:** CMS connection working."
      },
      "response": []
    },
    {
<<<<<<< HEAD
      "name": "4. Egress - List Workspace Files",
=======
      "name": "3. Egress - List Workspace Files",
>>>>>>> 8deb5fa (add postman collection and pipeline steps)
      "event": [
        {
          "listen": "prerequest",
          "script": {
            "exec": [
              "const accessToken = pm.collectionVariables.get('accessToken');\r",
              "const cmsAuth = pm.collectionVariables.get('cmsAuth');\r",
<<<<<<< HEAD
              "const egressWorkspaceId = pm.variables.get('egressWorkspaceId');\r",
=======
              "const egressWorkspaceId = pm.collectionVariables.get('egressWorkspaceId');\r",
>>>>>>> 8deb5fa (add postman collection and pipeline steps)
              "\r",
              "if (!accessToken) {\r",
              "    console.warn('WARNING: No accessToken');\r",
              "}\r",
              "if (!cmsAuth) {\r",
              "    console.warn('WARNING: No cmsAuth');\r",
              "}\r",
              "if (!egressWorkspaceId) {\r",
              "    console.warn('WARNING: No egressWorkspaceId - set this in environment');\r",
              "}"
            ],
            "type": "text/javascript",
            "packages": {},
            "requests": {}
          }
        },
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Status code is 200', function() {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test('Response is JSON', function() {",
              "    pm.response.to.be.json;",
              "});",
              "",
              "if (pm.response.code === 200) {",
              "    try {",
              "        const response = pm.response.json();",
              "        const files = response.files || response.items || response.data || response;",
              "        ",
              "        if (Array.isArray(files)) {",
              "            console.log('Egress files count:', files.length);",
              "            ",
              "            if (files.length > 0) {",
              "                // Store first file info for potential transfer",
              "                const firstFile = files[0];",
              "                pm.environment.set('egressFileId', firstFile.id || firstFile.fileId);",
              "                pm.environment.set('egressFileName', firstFile.name || firstFile.fileName);",
              "                console.log('First file:', firstFile.name || firstFile.fileName);",
              "            }",
              "        } else {",
              "            console.log('Response structure:', Object.keys(response));",
              "        }",
              "    } catch (e) {",
              "        console.error('Error parsing response:', e.message);",
              "    }",
              "}"
            ],
            "type": "text/javascript",
            "packages": {},
            "requests": {}
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{accessToken}}",
            "description": "Azure AD JWT token",
            "type": "text"
          },
          {
            "key": "Cookie",
            "value": "Cms-Auth-Values={{cmsAuth}}",
            "description": "CMS session cookies",
            "type": "text"
          },
          {
            "key": "Accept",
            "value": "application/json",
            "type": "text"
          },
          {
            "key": "Correlation-Id",
            "value": "{{correlationId}}",
            "type": "text"
          },
          {
            "key": "Origin",
            "value": "{{uiUrl}}",
            "type": "text"
          }
        ],
        "url": {
          "raw": "{{baseUrl}}/api/v1/egress/workspaces/{{egressWorkspaceId}}/files?take=1",
          "host": [
            "{{baseUrl}}"
          ],
          "path": [
            "api",
            "v1",
            "egress",
            "workspaces",
            "{{egressWorkspaceId}}",
            "files"
          ],
          "query": [
            {
              "key": "take",
              "value": "1"
            }
          ]
        },
        "description": "List files in an Egress workspace.\n\n**Proves:** Egress connection working.\n\n**Prerequisites:**\n\n- `bearerToken` - Azure AD JWT token\n    \n- `cmsAuthValues` - CMS cookies\n    \n- `egressWorkspaceId` - Egress workspace ID\n    \n\n**Query Parameters:**\n\n- `take` - Page size (default 1)\n    \n\n**Outputs:**\n\n- `egressFileId` - First file ID\n    \n- `egressFileName` - First file name"
      },
      "response": []
    },
    {
<<<<<<< HEAD
      "name": "5. NetApp - List Files",
=======
      "name": "4. NetApp - List Files",
>>>>>>> 8deb5fa (add postman collection and pipeline steps)
      "event": [
        {
          "listen": "prerequest",
          "script": {
            "exec": [
              "const accessToken = pm.collectionVariables.get('accessToken');",
              "const cmsAuth = pm.collectionVariables.get('cmsAuth');",
              "",
              "if (!accessToken) {",
              "    console.warn('WARNING: No accessToken');",
              "}",
              "if (!cmsAuth) {",
              "    console.warn('WARNING: No cmsAuth');",
              "}"
            ],
            "type": "text/javascript",
            "packages": {},
            "requests": {}
          }
        },
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Status code is 200', function() {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test('Response is JSON', function() {",
              "    pm.response.to.be.json;",
              "});",
              "",
              "if (pm.response.code === 200) {",
              "    try {",
              "        const response = pm.response.json();",
              "        const files = response.files || response.items || response.data || response;",
              "        ",
              "        // Store continuation token for pagination",
              "        if (response.continuationToken || response['continuation-token']) {",
              "            pm.environment.set('netappContinuationToken', response.continuationToken || response['continuation-token']);",
              "            console.log('Continuation token stored');",
              "        }",
              "        ",
              "        if (Array.isArray(files)) {",
              "            console.log('NetApp files count:', files.length);",
              "            ",
              "            if (files.length > 0) {",
              "                // Store first file info for potential transfer",
              "                const firstFile = files[0];",
              "                pm.environment.set('netappFilePath', firstFile.path || firstFile.name);",
              "                pm.environment.set('netappFileName', firstFile.name || firstFile.fileName);",
              "                console.log('First file:', firstFile.name || firstFile.path);",
              "            }",
              "        } else {",
              "            console.log('Response structure:', Object.keys(response));",
              "        }",
              "    } catch (e) {",
              "        console.error('Error parsing response:', e.message);",
              "    }",
              "}"
            ],
            "type": "text/javascript",
            "packages": {},
            "requests": {}
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{accessToken}}",
            "description": "Azure AD JWT token",
            "type": "text"
          },
          {
            "key": "Cookie",
            "value": "Cms-Auth-Values={{cmsAuth}}",
            "description": "CMS session cookies",
            "type": "text"
          },
          {
            "key": "Accept",
            "value": "application/json",
            "type": "text"
          },
          {
            "key": "Correlation-Id",
            "value": "{{correlationId}}",
            "type": "text"
          },
          {
            "key": "Origin",
            "value": "{{uiUrl}}",
            "type": "text"
          }
        ],
        "url": {
          "raw": "{{baseUrl}}/api/v1/netapp/files?take=1",
          "host": [
            "{{baseUrl}}"
          ],
          "path": [
            "api",
            "v1",
            "netapp",
            "files"
          ],
          "query": [
            {
              "key": "take",
              "value": "1",
              "description": "Number of items to return (default 50)"
            }
          ]
        },
        "description": "List files from NetApp storage.\n\n**Proves:** NetApp connection working.\n\n**Prerequisites:**\n\n- `bearerToken` - Azure AD JWT token\n    \n- `cmsAuthValues` - CMS cookies\n    \n\n**Query Parameters:**\n\n- `take` - Page size (default 1)\n    \n\n**Outputs:**\n\n- `netappFilePath` - First file path\n    \n- `netappFileName` - First file name\n    \n- `netappContinuationToken` - Token for next page"
      },
      "response": []
    }
  ],
  "auth": {
    "type": "bearer",
    "bearer": [
      {
        "key": "token",
        "value": "{{accessToken}}",
        "type": "string"
      }
    ]
  },
  "event": [
    {
      "listen": "prerequest",
      "script": {
        "type": "text/javascript",
        "requests": {},
        "exec": [
          "/**",
          " * Collection-level Pre-Request Script",
          " * ",
          " * Automatic authentication:",
          " * 1. Azure AD Token - ROPC flow (user_impersonation)",
          " * 2. CMS Auth - DDEI /authenticate endpoint",
          " * 3. Variable generation",
          " */",
          "",
          "(function () {",
          "  const vars = pm.variables;",
          "  const collVars = pm.collectionVariables;",
          "",
          "  // ============================================",
          "  // PART 1: Azure AD Token (ROPC Flow)",
          "  // ============================================",
          "  console.log('=== Azure AD Token (ROPC) ===');",
          "  ",
          "  const tenantId = vars.get('tenantId');",
          "  const apiClientId = vars.get('apiClientId');",
<<<<<<< HEAD
          "  const aadUsername = vars.get('aadUsername');",
=======
          "  const aadUsename = vars.get('aadUsename');",
>>>>>>> 8deb5fa (add postman collection and pipeline steps)
          "  const aadPassword = vars.get('aadPassword');",
          "",
          "  const missingAadVars = [];",
          "  if (!tenantId) missingAadVars.push('tenantId');",
          "  if (!apiClientId) missingAadVars.push('apiClientId');",
<<<<<<< HEAD
          "  if (!aadUsername) missingAadVars.push('aadUsername');",
=======
          "  if (!aadUsename) missingAadVars.push('aadUsename');",
>>>>>>> 8deb5fa (add postman collection and pipeline steps)
          "  if (!aadPassword) missingAadVars.push('aadPassword');",
          "",
          "  if (missingAadVars.length > 0) {",
          "    console.log('[AAD] Skipping - missing: ' + missingAadVars.join(', '));",
          "  } else {",
          "    const now = Date.now();",
          "    const expiry = parseInt(collVars.get('accessTokenExpiry') || '0');",
          "    ",
          "    // Refresh if expired or expiring in 60 seconds",
          "    if (!expiry || now >= expiry - 60000) {",
          "      console.log('[AAD] Requesting token via ROPC...');",
          "      const tokenUrl = 'https://login.microsoftonline.com/' + tenantId + '/oauth2/v2.0/token';",
          "      const scope = 'api://' + apiClientId + '/user_impersonation';",
          "",
          "      pm.sendRequest({",
          "        url: tokenUrl,",
          "        method: 'POST',",
          "        header: { 'Content-Type': 'application/x-www-form-urlencoded' },",
          "        body: {",
          "          mode: 'urlencoded',",
          "          urlencoded: [",
          "            { key: 'client_id', value: apiClientId },",
          "            { key: 'scope', value: scope },",
<<<<<<< HEAD
          "            { key: 'username', value: aadUsername },",
=======
          "            { key: 'username', value: aadUsename },",
>>>>>>> 8deb5fa (add postman collection and pipeline steps)
          "            { key: 'password', value: aadPassword },",
          "            { key: 'grant_type', value: 'password' }",
          "          ]",
          "        }",
          "      }, function (err, res) {",
          "        if (err) {",
          "          console.error('[AAD] Request failed: ' + err);",
          "          return;",
          "        }",
          "        ",
          "        let json;",
          "        try {",
          "          json = res.json();",
          "        } catch (e) {",
          "          console.error('[AAD] Failed to parse response');",
          "          return;",
          "        }",
          "        ",
          "        if (json.error) {",
          "          console.error('[AAD] Error: ' + json.error + ' - ' + (json.error_description || ''));",
          "          return;",
          "        }",
          "        ",
          "        const accessToken = json.access_token;",
          "        const expiresIn = Number(json.expires_in);",
          "        ",
          "        if (accessToken) {",
          "          collVars.set('accessToken', accessToken);",
          "          collVars.set('accessTokenExpiry', String(now + (expiresIn * 1000)));",
          "          console.log('[AAD] Token obtained (expires in ' + expiresIn + 's)');",
          "        }",
          "      });",
          "    } else {",
          "      console.log('[AAD] Using cached token');",
          "    }",
          "  }",
          "",
          "  // ============================================",
          "  // PART 2: CMS Authentication via DDEI",
          "  // ============================================",
          "  console.log('=== CMS Authentication (DDEI) ===');",
          "  ",
          "  const ddeiBaseUrl = vars.get('ddeiBaseUrl');",
          "  const ddeiAccessKey = vars.get('ddeiAccessKey');",
          "  const cmsUsername = vars.get('cmsUsername');",
          "  const cmsPassword = vars.get('cmsPassword');",
          "",
          "  const missingCmsVars = [];",
          "  if (!ddeiBaseUrl) missingCmsVars.push('ddeiBaseUrl');",
          "  if (!ddeiAccessKey) missingCmsVars.push('ddeiAccessKey');",
          "  if (!cmsUsername) missingCmsVars.push('cmsUsername');",
          "  if (!cmsPassword) missingCmsVars.push('cmsPassword');",
          "",
          "  if (missingCmsVars.length > 0) {",
          "    console.log('[CMS] Skipping - missing: ' + missingCmsVars.join(', '));",
          "  } else {",
          "    // Check if CMS auth is still valid (has Token)",
          "    const existingAuth = collVars.get('cmsAuth');",
          "    const cmsExpiry = parseInt(collVars.get('cmsAuthExpiry') || '0');",
          "    const now = Date.now();",
          "    ",
          "    if (existingAuth && cmsExpiry && now < cmsExpiry - 60000) {",
          "      console.log('[CMS] Using cached auth');",
          "    } else {",
          "      console.log('[CMS] Authenticating via DDEI...');",
          "      const authUrl = ddeiBaseUrl + '/authenticate';",
          "",
          "      pm.sendRequest({",
          "        url: authUrl,",
          "        method: 'POST',",
          "        header: {",
          "          'Content-Type': 'application/x-www-form-urlencoded',",
          "          'x-functions-key': ddeiAccessKey",
          "        },",
          "        body: {",
          "          mode: 'urlencoded',",
          "          urlencoded: [",
          "            { key: 'username', value: cmsUsername },",
          "            { key: 'password', value: cmsPassword }",
          "          ]",
          "        }",
          "      }, function (err, res) {",
          "        if (err) {",
          "          console.error('[CMS] Auth failed: ' + err);",
          "          return;",
          "        }",
          "        ",
          "        if (res.code >= 400) {",
          "          console.error('[CMS] Auth failed with status ' + res.code);",
          "          return;",
          "        }",
          "        ",
          "        let json;",
          "        try {",
          "          json = res.json();",
          "        } catch (e) {",
          "          console.error('[CMS] Failed to parse response');",
          "          return;",
          "        }",
          "        ",
          "        if (json && json.Cookies) {",
          "          const compactJson = JSON.stringify(json);",
          "          const encoded = encodeURIComponent(compactJson);",
          "          ",
          "          collVars.set('cmsAuth', encoded);",
          "          ",
          "          // Set expiry (default 20 minutes if not provided)",
          "          if (json.ExpiryTime) {",
          "            const expiryTime = new Date(json.ExpiryTime).getTime();",
          "            collVars.set('cmsAuthExpiry', String(expiryTime));",
          "          } else {",
          "            collVars.set('cmsAuthExpiry', String(now + 20 * 60 * 1000));",
          "          }",
          "          ",
          "          console.log('[CMS] Authentication successful');",
          "        }",
          "      });",
          "    }",
          "  }",
          "",
          "  // ============================================",
          "  // PART 3: Generate Request Variables",
          "  // ============================================",
          "  console.log('=== Request Variables ===');",
          "  ",
          "  // Generate correlation ID",
<<<<<<< HEAD
          "  const correlationId = pm.variables.replaceIn('{{$guid}}');",
=======
          "  const correlationId = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {",
          "    var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);",
          "    return v.toString(16);",
          "  });",
>>>>>>> 8deb5fa (add postman collection and pipeline steps)
          "  collVars.set('correlationId', correlationId);",
          "  ",
          "  // Generate dates",
          "  const today = new Date();",
          "  const tomorrow = new Date(today);",
          "  tomorrow.setDate(tomorrow.getDate() + 1);",
          "  ",
          "  collVars.set('today', today.toISOString().split('T')[0]);",
          "  collVars.set('tomorrow', tomorrow.toISOString().split('T')[0]);",
          "  ",
          "  // Generate unique URN reference",
          "  const uniqueRef = String(Math.floor(10000 + Math.random() * 90000));",
          "  collVars.set('urnUniqueRef', uniqueRef);",
          "  ",
          "  console.log('[VAR] correlationId: ' + correlationId);",
          "  console.log('=== Pre-Request Complete ===');",
          "",
          "})();"
        ]
      }
    },
    {
      "listen": "test",
      "script": {
        "type": "text/javascript",
        "requests": {},
        "exec": [
          "// Collection-level tests"
        ]
      }
    }
  ],
  "variable": [
    {
      "key": "baseUrl",
      "value": ""
    },
    {
<<<<<<< HEAD
=======
      "key": "egressBaseUrl",
      "value": ""
    },
    {
>>>>>>> 8deb5fa (add postman collection and pipeline steps)
      "key": "ddeiBaseUrl",
      "value": ""
    },
    {
      "key": "apiClientId",
      "value": ""
    },
    {
      "key": "ddeiAccessKey",
      "value": ""
    },
    {
      "key": "cmsUsername",
      "value": ""
    },
    {
      "key": "egressWorkspaceId",
      "value": ""
    },
    {
<<<<<<< HEAD
=======
      "key": "egressUsername",
      "value": ""
    },
    {
      "key": "egressPassword",
      "value": ""
    },
    {
>>>>>>> 8deb5fa (add postman collection and pipeline steps)
      "key": "cmsPassword",
      "value": ""
    },
    {
<<<<<<< HEAD
      "key": "aadUsername",
=======
      "key": "aadUsename",
>>>>>>> 8deb5fa (add postman collection and pipeline steps)
      "value": ""
    },
    {
      "key": "aadPassword",
      "value": ""
    },
    {
      "key": "tenantId",
      "value": ""
    },
    {
      "key": "uiUrl",
      "value": ""
    },
    {
      "key": "correlationId",
      "value": ""
    },
    {
      "key": "today",
      "value": ""
    },
    {
      "key": "tomorrow",
      "value": ""
    },
    {
      "key": "urnUniqueRef",
      "value": ""
    },
    {
      "key": "cmsAuth",
      "value": ""
    },
    {
      "key": "cmsAuthExpiry",
      "value": ""
    },
    {
      "key": "accessToken",
      "value": ""
    },
    {
      "key": "accessTokenExpiry",
      "value": ""
    }
  ]
}