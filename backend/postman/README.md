# Smoke Test to Verify Connection to External Services

## Overview

This collection tests LCC's main API connectivity to its external dependencies:  
\- Case Management Datastore  
\- CMS  
\- Egress  
\- NetApp

## Authentication

### Azure AD Token (Collection Level)

The collection-level pre-request script automatically retrieves an Azure AD access token using the OAuth 2.0 Resource Owner Password Credentials (ROPC) grant flow.

**How it works:**  
\- Tokens are fetched using collection variables: \`tenantId\`, \`clientId\`, \`aadUsername\`, \`aadPassword\`  
\- Token is cached in \`accessToken\` and \`accessTokenExpiry\` collection variables  
\- Auto-refreshes 60 seconds before expiry  
\- Authorization header set at collection level: \`Bearer \`

### CMS Authentication Cookie

The **Cms-Auth-Values** cookie is set via pre-request script:  
\- Calls the environment-specific MDS \`/authenticate\` endpoint  
\- Uses \`ddeiBaseUrl\`, \`cmsUsername\`, \`cmsPassword\` variables  
\- Retrieves and sets the authentication cookie value automatically

## Setup Instructions

1\. Import Collection and Environment

Import the following files into Postman:  
\- \`LCCMainAPISmokeTest.postman_collection.json\`  
\- Your environment file (Local, Dev, etc.)

2\. Configure Collection Variables

Ensure these collection variables are populated:

| Variable | Description | Notes |
| --- | --- | --- |
| urnUniqueRef | 5-digit unique reference number | Autogenerated in Pre-Script |
| accessTokenExpiry | Token expiry timestamp (auto-managed) | Autogenerated in Pre-Script |
| ddeiBaseUrl | MDS API base URL |  |
| ddeiAccessKey | MDS API access key |  |
| cmsUsername | CMS authentication username |  |
| cmsPassword | CMS authentication password |  |
| cmsAuth | CMS auth cookie value (auto-managed) | Autogenerated in Pre-Script |
| baseUrl | LCC API URL |  |
| clientId | Azure AD application (client) ID |  |
| aadUsername | Azure AD username |  |
| aadPassword | Azure AD user password |  |
| tenantId | Azure AD application (tenant) ID |  |

## Test Requests

The collection hits four key endpoints:

| Endpoint | What it proves |
| --- | --- |
| `GET /api/status` | The API is running.  <br>Also used to verify authentication to CMS and AAD and stops run if unsuccessful. |
| `GET /api/v1/activity/logs` | Datastore connection working |
| `GET /api/v1/areas` | DDEI/CMS connection working |
| `GET /api/v1/egress/workspaces/{id}/files` | Egress connection working |
| `GET /api/v1/netapp/files` | NetApp connectionworking |

## Pre-Request Script

The collection pre-request script automatically generates:  
\- \`correlationId\` - A new GUID for each request  
\- \`today\` - Current date in ISO format  
\- \`tomorrow\` - Tomorrow's date in ISO format  
\- \`urnUniqueRef\` - A random 5-digit number

## Troubleshooting

**Authentication Failures**

\- Verify \`tenantId\`, \`clientId\`, \`aadUsername\`, and \`aadPassword\` are correct  
\- Check Azure AD app registration has appropriate API permissions  
\- Ensure CMS credentials (\`cmsUsername\`, \`cmsPassword\`) are valid

**Token Not Refreshing**

\- The token auto-refreshes 60s before expiry  
\- If issues persist, manually delete \`accessToken\` and \`accessTokenExpiry\` variables to force a new token

**Cookie Issues**

\- Verify \`ddeiBaseUrl\` points to the correct environment  
\- Check DDEI \`/authenticate\` endpoint is accessible  
\- Ensure \`ddeiAccessKey\` is valid

**Test Failures**

\- Review the "Test Results" tab for specific assertion failures  
\- Check the response body for validation errors  
\- Verify request payload matches expected schema